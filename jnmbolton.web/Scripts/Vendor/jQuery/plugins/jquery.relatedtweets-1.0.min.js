(function(n){n.fn.relatedTweets=function(t){var i={debug:0,query:"",default_query:"",realtime:1,status:0,lang:"en",n:10,max_tags:5,or_tags:1,show_avatar:1,show_author:1,show_date:1,show_source:1,image_width:48,from_users:"",to_users:"",at_users:"",links_only:0,geocode:"",stay_time:5e3,enter_time:300,exit_time:200,animate:"opacity"};return t=n.extend({},i,t),this.each(function(){var div=n(this),count=0,ul=null,max_id=0,visibleI=-1,calls=0,removeExtra=!1,effectParams={},op=t;if(div.attr("options")){try{op=eval("("+div.attr("options")+")")}catch(e){op.debug&&div.html('<b style="color:red">'+e+"<\/b>");return}op=n.extend({},i,op)}var searchLoaded=function(t){var i,u,r;if(!t.results||!t.max_id){op.debug&&div.html('<b style="color:red">Error:'+(t.error?t.error:"unkown")+"<\/b>");return}if(i=t.results,t.max_id>0&&(max_id=t.max_id),calls==0){if(i.length==0)return;count=i.length,u=n('<div class="rrt-inner"><\/div>').appendTo(div.html("")),ul=n("<ul><\/ul>").appendTo(u)}for(calls++,r=i.length-1;r>=0;r--)appendLI(i[r],i.length-1-r);calls>1&&i.length&&(removeExtra=!0),calls==1&&fadeOut()},appendLI=function(t){n('<li style="display:none;">'+(op.show_avatar?'<span class="rrt-author-img"><a href="http://twitter.com/'+t.from_user+'" title="'+t.from_user+'"><img src="'+t.profile_image_url+'" height="'+op.image_width+'" width="'+op.image_width+'" border="0"/><\/a><\/span>':"")+'<span class="rrt-body">'+(op.show_author?'<strong><a href="http://twitter.com/'+t.from_user+'" title="'+t.from_user+'">'+t.from_user+"<\/a><\/strong>":"")+'<span class="rrt-content">'+linkify(t.text)+'<\/span><span class="rrt-meta">'+(op.show_date?'<a class="rrt-date" href="http://twitter.com/'+t.from_user+"/status/"+t.id_str+'">'+formatDate(t.created_at)+"<\/a>":"")+(op.show_source?'<span class="rrt-source"> from '+decodeHTML(t.source)+"<\/span>":"")+"<\/span><\/span><\/li>").appendTo(ul)},fadeOut=function(){visibleI>-1?n("li",ul).eq(visibleI).fadeOut(op.exit_time,fadeIn):fadeIn()},fadeIn=function(){removeExtra&&removeExtraLI(),visibleI++,visibleI>=count&&(visibleI=0),effectParams[op.animate]="show",n("li",ul).eq(visibleI).animate(effectParams,op.enter_time,"linear",fadeStill),visibleI+1>=count&&op.realtime&&search()},fadeStill=function(){n("li",ul).eq(visibleI).animate({opacity:1},op.stay_time,"linear",fadeOut)},removeExtraLI=function(){var t=n("li",ul).size();t>op.n?(n("li:lt("+(t-op.n)+")",ul).remove(),count=op.n):count=t,removeExtra=!1},linkify=function(n){return n.replace(/\bhttps?\:\/\/\S+/gi,function(n){var t="";return n=n.replace(/(\.*|\?*|\!*)$/,function(n,i){return t=i,""}),'<a class="rrt-link" href="'+n+'">'+(n.length>25?n.substr(0,24)+"...":n)+"<\/a>"+t}).replace(/\B\@([A-Z0-9_]{1,15})/gi,'@<a class="rrt-at" href="http://twitter.com/$1">$1<\/a>').replace(/\B\#([A-Z0-9_]+)/gi,'<a class="rrt-hashtag" href="http://search.twitter.com/search?q=%23$1">#$1<\/a>')},decodeHTML=function(n){return n.replace(/&lt;/gi,"<").replace(/&gt;/gi,">").replace(/&quot;/gi,'"')},formatDate=function(n){var t=new Date,i=new Date,r,u,f;t.setTime(Date.parse(n));var h=i.getDate(),c=i.getMonth()+1,l=i.getFullYear(),a=i.getHours(),v=i.getMinutes(),y=i.getSeconds(),e=t.getDate(),o=t.getMonth()+1,s=t.getFullYear(),p=t.getHours(),w=t.getMinutes(),b=t.getSeconds();return s==l&&o==c&&e==h?(r=a-p,r>0)?r+" hour"+(r>1?"s":"")+" ago":(u=v-w,u>0)?u+" minute"+(u>1?"s":"")+" ago":(f=y-b,f+" second"+(f>1?"s":"")+" ago"):o+"/"+e+"/"+s},search=function(){var t={lang:op.lang,q:op.query,rpp:op.n,since_id:max_id};op.geocode&&(t.geocode=op.geocode),n.ajax({url:"http://search.twitter.com/search.json",data:t,success:searchLoaded,dataType:"jsonp"})},init=function(){var t=[];op.query||op.status||n('a[rel="tag"]:lt('+op.max_tags+")").each(function(){var i=n.trim(n(this).text().replace(/\n/g,""));n.inArray(i,t)==-1&&(t[t.length]=i)}),t.length>0&&(op.query=t.join(op.or_tags?" OR ":" ")),op.query||(op.query=op.default_query),op.from_users&&(op.query+=" from:"+op.from_users.replace(/\s/g,"").replace(/,/g," OR from:")),op.to_users&&(op.query+=" to:"+op.to_users.replace(/\s/g,"").replace(/,/g," OR to:")),op.at_users&&(op.query+=" @"+op.at_users.replace(/\s/g,"").replace(/,/g," OR @")),op.links_only&&(op.query+=" filter:links"),search()};init()})}})(jQuery),jQuery(document).ready(function(){jQuery("div.related-tweets").relatedTweets()});