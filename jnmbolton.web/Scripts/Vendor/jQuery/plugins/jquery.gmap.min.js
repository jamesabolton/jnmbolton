(function(n){"use strict";var r=function(){this.markers=[],this.mainMarker=!1,this.icon="http://www.google.com/mapfiles/marker.png"};r.prototype.dist=function(n){return Math.sqrt(Math.pow(this.markers[0].latitude-n.latitude,2)+Math.pow(this.markers[0].longitude-n.longitude,2))},r.prototype.setIcon=function(n){this.icon=n},r.prototype.addMarker=function(n){this.markers[this.markers.length]=n},r.prototype.getMarker=function(){if(this.mainmarker)return this.mainmarker;var n,i;return this.markers.length>1?(n=new t.MarkerImage("http://chart.googleapis.com/chart?chst=d_map_pin_letter&chld="+this.markers.length+"%7cff776b%7c000000"),i="cluster of "+this.markers.length+" markers"):(n=new t.MarkerImage(this.icon),i=this.markers[0].title),this.mainmarker=new t.Marker({position:new t.LatLng(this.markers[0].latitude,this.markers[0].longitude),icon:n,title:i,map:null}),this.mainmarker};var t=google.maps,u=new t.Geocoder,f=0,e=0,i={};i={init:function(r){var f,u=n.extend({},n.fn.gMap.defaults,r);for(f in n.fn.gMap.defaults.icon)u.icon[f]||(u.icon[f]=n.fn.gMap.defaults.icon[f]);return this.each(function(){var f=n(this),s=i._getMapCenter.apply(f,[u]),e,h,r,o;if(u.zoom=="fit"&&(u.zoomFit=!0,u.zoom=i._autoZoom.apply(f,[u])),r={zoom:u.zoom,center:s,mapTypeControl:u.mapTypeControl,mapTypeControlOptions:{},zoomControl:u.zoomControl,zoomControlOptions:{},panControl:u.panControl,panControlOptions:{},scaleControl:u.scaleControl,scaleControlOptions:{},streetViewControl:u.streetViewControl,streetViewControlOptions:{},mapTypeId:u.maptype,scrollwheel:u.scrollwheel,maxZoom:u.maxZoom,minZoom:u.minZoom},u.controlsPositions.mapType&&(r.mapTypeControlOptions.position=u.controlsPositions.mapType),u.controlsPositions.zoom&&(r.zoomControlOptions.position=u.controlsPositions.zoom),u.controlsPositions.pan&&(r.panControlOptions.position=u.controlsPositions.pan),u.controlsPositions.scale&&(r.scaleControlOptions.position=u.controlsPositions.scale),u.controlsPositions.streetView&&(r.streetViewControlOptions.position=u.controlsPositions.streetView),u.styles&&(r.styles=u.styles),r.mapTypeControlOptions.style=u.controlsStyle.mapType,r.zoomControlOptions.style=u.controlsStyle.zoom,r=n.extend(r,u.extra),o=new t.Map(this,r),u.log&&console.log("map center is:"),u.log&&console.log(s),f.data("$gmap",o),f.data("gmap",{opts:u,gmap:o,markers:[],markerKeys:{},infoWindow:null,clusters:[]}),u.controls.length!==0)for(e=0;e<u.controls.length;e+=1)o.controls[u.controls[e].pos].push(u.controls[e].div);u.clustering.enabled?(h=f.data("gmap"),function(n){h.markers=n}(u.markers),i._renderCluster.apply(f,[]),t.event.addListener(o,"bounds_changed",function(){i._renderCluster.apply(f,[])})):u.markers.length!==0&&i.addMarkers.apply(f,[u.markers]),i._onComplete.apply(f,[])})},_delayedMode:!1,_onComplete:function(){var n=this.data("gmap"),u=this,t,r;if(f!==0){window.setTimeout(function(){i._onComplete.apply(u,[])},100);return}i._delayedMode&&(t=i._getMapCenter.apply(this,[n.opts,!0]),i._setMapCenter.apply(this,[t]),n.opts.zoomFit&&(r=i._autoZoom.apply(this,[n.opts,!0]),n.gmap.setZoom(r))),n.opts.onComplete()},_setMapCenter:function(n){var t=this.data("gmap"),r;t&&t.opts.log&&console.log("delayed setMapCenter called"),t&&t.gmap!==undefined&&f==0?t.gmap.setCenter(n):(r=this,window.setTimeout(function(){i._setMapCenter.apply(r,[n])},100))},_boundaries:null,_getBoundaries:function(n){var r=n.markers,t,u=1e3,f=-1e3,e=1e3,o=-1e3;if(r){for(t=0;t<r.length;t+=1)r[t].latitude&&r[t].longitude&&(u>r[t].latitude&&(u=r[t].latitude),f<r[t].longitude&&(f=r[t].longitude),e>r[t].longitude&&(e=r[t].longitude),o<r[t].latitude&&(o=r[t].latitude),n.log&&console.log(r[t].latitude,r[t].longitude,u,f,e,o));i._boundaries={N:u,E:f,W:e,S:o}}return u==-1e3&&(i._boundaries={N:0,E:0,W:0,S:0}),i._boundaries},_getBoundariesFromMarkers:function(){var t=this.data("gmap").markers,n,r=1e3,u=-1e3,f=1e3,e=-1e3;if(t){for(n=0;n<t.length;n+=1)r>t[n].getPosition().lat()&&(r=t[n].getPosition().lat()),u<t[n].getPosition().lng()&&(u=t[n].getPosition().lng()),f>t[n].getPosition().lng()&&(f=t[n].getPosition().lng()),e<t[n].getPosition().lat()&&(e=t[n].getPosition().lat());i._boundaries={N:r,E:u,W:f,S:e}}return r==-1e3&&(i._boundaries={N:0,E:0,W:0,S:0}),i._boundaries},_getMapCenter:function(n,r){var o,h=this,f,e,s;if(n.markers.length&&(n.latitude=="fit"||n.longitude=="fit"))return s=r?i._getBoundariesFromMarkers.apply(this):i._getBoundaries(n),o=new t.LatLng((s.N+s.S)/2,(s.E+s.W)/2),n.log&&console.log(r,s,o),o;if(n.latitude&&n.longitude)return new t.LatLng(n.latitude,n.longitude);if(o=new t.LatLng(0,0),n.address)return u.geocode({address:n.address},function(t,r){r===google.maps.GeocoderStatus.OK?i._setMapCenter.apply(h,[t[0].geometry.location]):n.log&&console.log("Geocode was not successful for the following reason: "+r)}),o;if(n.markers.length>0){for(e=null,f=0;f<n.markers.length;f+=1)if(n.markers[f].setCenter){e=n.markers[f];break}if(e===null)for(f=0;f<n.markers.length;f+=1){if(n.markers[f].latitude&&n.markers[f].longitude){e=n.markers[f];break}n.markers[f].address&&(e=n.markers[f])}if(e===null)return o;if(e.latitude&&e.longitude)return new t.LatLng(e.latitude,e.longitude);e.address&&u.geocode({address:e.address},function(t,r){r===google.maps.GeocoderStatus.OK?i._setMapCenter.apply(h,[t[0].geometry.location]):n.log&&console.log("Geocode was not successful for the following reason: "+r)})}return o},_renderCluster:function(){for(var o=this.data("gmap"),f=o.markers,t=o.clusters,s=o.opts,u,h,p,n=0;n<t.length;n+=1)t[n].getMarker().setMap(null);if(t.length=0,h=o.gmap.getBounds(),!h){p=this,window.setTimeout(function(){i._renderCluster.apply(p)},1e3);return}var l=h.getNorthEast(),a=h.getSouthWest(),k=l.lat()-a.lat(),e=[],c,w,b=k*s.clustering.clusterSize/100,v,y;for(n=0;n<f.length;n+=1)f[n].latitude<l.lat()&&f[n].latitude>a.lat()&&f[n].longitude<l.lng()&&f[n].longitude>a.lng()&&(e[e.length]=f[n]);for(s.log&&console.log("number of markers "+e.length+"/"+f.length),s.log&&console.log("cluster radius: "+b),n=0;n<e.length;n+=1){for(w=1e4,c=-1,u=0;u<t.length;u+=1)if(v=t[u].dist(e[n]),v<b&&(w=v,c=u,s.clustering.fastClustering))break;c===-1?(y=new r,y.addMarker(e[n]),t[t.length]=y):t[c].addMarker(e[n])}for(s.log&&console.log("Total clusters in viewport: "+t.length),u=0;u<t.length;u+=1)t[u].getMarker().setMap(o.gmap)},_processMarker:function(n,i,r,u){var e=this.data("gmap"),c=e.gmap,f=e.opts,o,l,s,y,h,v,a;u===undefined&&(u=new t.LatLng(n.latitude,n.longitude)),i||(s={image:f.icon.image,iconSize:new t.Size(f.icon.iconsize[0],f.icon.iconsize[1]),iconAnchor:new t.Point(f.icon.iconanchor[0],f.icon.iconanchor[1]),infoWindowAnchor:new t.Size(f.icon.infowindowanchor[0],f.icon.infowindowanchor[1])},i=new t.MarkerImage(s.image,s.iconSize,null,s.iconAnchor)),r||(y={image:f.icon.shadow,iconSize:new t.Size(f.icon.shadowsize[0],f.icon.shadowsize[1]),anchor:s&&s.iconAnchor?s.iconAnchor:new t.Point(f.icon.iconanchor[0],f.icon.iconanchor[1])}),l={position:u,icon:i,title:n.title,map:null,draggable:n.draggable===!0?!0:!1},f.clustering.enabled||(l.map=c),o=new t.Marker(l),o.setShadow(r),e.markers.push(o),n.key&&(e.markerKeys[n.key]=o),n.html&&(v=typeof n.html=="string"?f.html_prepend+n.html+f.html_append:n.html,a={content:v,pixelOffset:n.infoWindowAnchor},f.log&&console.log("setup popup with data"),f.log&&console.log(a),h=new t.InfoWindow(a),t.event.addListener(o,"click",function(){f.log&&console.log("opening popup "+n.html),f.singleInfoWindow&&e.infoWindow&&e.infoWindow.close(),h.open(c,o),e.infoWindow=h})),n.html&&n.popup&&(f.log&&console.log("opening popup "+n.html),h.open(c,o),e.infoWindow=h),n.onDragEnd&&t.event.addListener(o,"dragend",function(t){f.log&&console.log("drag end");n.onDragEnd(t)})},_geocodeMarker:function(n,r,o){var s=this;u.geocode({address:n.address},function(u,h){h===t.GeocoderStatus.OK?(f-=1,s.data("gmap").opts.log&&console.log("Geocode was successful with point: ",u[0].geometry.location),i._processMarker.apply(s,[n,r,o,u[0].geometry.location])):(h===t.GeocoderStatus.OVER_QUERY_LIMIT&&(s.data("gmap").opts.noAlerts||e!==0||alert("Error: too many geocoded addresses! Switching to 1 marker/s mode."),e+=1e3,window.setTimeout(function(){i._geocodeMarker.apply(s,[n,r,o])},e)),s.data("gmap").opts.log&&console.log("Geocode was not successful for the following reason: "+h))})},_autoZoom:function(t,r){var o=n(this).data("gmap"),s=n.extend({},o?o.opts:{},t),f,u,h,c,e=39135.758482;for(s.log&&console.log("autozooming map"),u=r?i._getBoundariesFromMarkers.apply(this):i._getBoundaries(s),h=(u.E-u.W)*111e3/this.width(),c=(u.S-u.N)*111e3/this.height(),f=2;f<20;f+=1){if(h>e||c>e)break;e=e/2}return f-2},addMarkers:function(n){var r=this.data("gmap").opts,t;if(n.length!==0)for(r.log&&console.log("adding "+n.length+" markers"),t=0;t<n.length;t+=1)i.addMarker.apply(this,[n[t]])},addMarker:function(n){var r=this.data("gmap").opts,u,e,o,s,h;r.log&&console.log("putting marker at "+n.latitude+", "+n.longitude+" with address "+n.address+" and html "+n.html),u={image:r.icon.image,iconSize:new t.Size(r.icon.iconsize[0],r.icon.iconsize[1]),iconAnchor:new t.Point(r.icon.iconanchor[0],r.icon.iconanchor[1]),infoWindowAnchor:new t.Size(r.icon.infowindowanchor[0],r.icon.infowindowanchor[1])},e={image:r.icon.shadow,iconSize:new t.Size(r.icon.shadowsize[0],r.icon.shadowsize[1]),anchor:new t.Point(r.icon.shadowanchor[0],r.icon.shadowanchor[1])},n.infoWindowAnchor=u.infoWindowAnchor,n.icon&&(n.icon.image&&(u.image=n.icon.image),n.icon.iconsize&&(u.iconSize=new t.Size(n.icon.iconsize[0],n.icon.iconsize[1])),n.icon.iconanchor&&(u.iconAnchor=new t.Point(n.icon.iconanchor[0],n.icon.iconanchor[1])),n.icon.infowindowanchor&&(u.infoWindowAnchor=new t.Size(n.icon.infowindowanchor[0],n.icon.infowindowanchor[1])),n.icon.shadow&&(e.image=n.icon.shadow),n.icon.shadowsize&&(e.iconSize=new t.Size(n.icon.shadowsize[0],n.icon.shadowsize[1])),n.icon.shadowanchor&&(e.anchor=new t.Point(n.icon.shadowanchor[0],n.icon.shadowanchor[1]))),o=new t.MarkerImage(u.image,u.iconSize,null,u.iconAnchor),s=new t.MarkerImage(e.image,e.iconSize,null,e.anchor),n.address?(n.html==="_address"&&(n.html=n.address),n.title=="_address"&&(n.title=n.address),r.log&&console.log("geocoding marker: "+n.address),f+=1,i._delayedMode=!0,i._geocodeMarker.apply(this,[n,o,s])):(n.html==="_latlng"&&(n.html=n.latitude+", "+n.longitude),n.title=="_latlng"&&(n.title=n.latitude+", "+n.longitude),h=new t.LatLng(n.latitude,n.longitude),i._processMarker.apply(this,[n,o,s,h]))},removeAllMarkers:function(){for(var t=this.data("gmap").markers,n=0;n<t.length;n+=1)t[n].setMap(null),delete t[n];t.length=0},getMarker:function(n){return this.data("gmap").markerKeys[n]},fixAfterResize:function(n){var i=this.data("gmap");t.event.trigger(i.gmap,"resize"),n&&i.gmap.panTo(new google.maps.LatLng(0,0)),i.gmap.panTo(this.gMap("_getMapCenter",i.opts))},setZoom:function(n,t,r){var u=this.data("gmap").gmap;n==="fit"&&(n=i._autoZoom.apply(this,[t,r])),u.setZoom(parseInt(n))},changeSettings:function(n){for(var r=this.data("gmap"),u=[],t=0;t<r.markers.length;t+=1)u[t]={latitude:r.markers[t].getPosition().lat(),longitude:r.markers[t].getPosition().lng()};n.markers=u,n.zoom&&i.setZoom.apply(this,[n.zoom,n]),(n.latitude||n.longitude)&&r.gmap.panTo(i._getMapCenter.apply(this,[n]))},mapclick:function(n){google.maps.event.addListener(this.data("gmap").gmap,"click",function(t){n(t.latLng)})},geocode:function(n,i,r){u.geocode({address:n},function(n,u){u===t.GeocoderStatus.OK?i(n[0].geometry.location):r&&r(n,u)})},getRoute:function(i){var r=this.data("gmap"),l=r.gmap,f=new t.DirectionsRenderer,a=new t.DirectionsService,e={BYCAR:t.DirectionsTravelMode.DRIVING,BYBICYCLE:t.DirectionsTravelMode.BICYCLING,BYFOOT:t.DirectionsTravelMode.WALKING},o={MILES:t.DirectionsUnitSystem.IMPERIAL,KM:t.DirectionsUnitSystem.METRIC},u=null,s=null,h=null,c;return i.routeDisplay!==undefined?u=i.routeDisplay instanceof jQuery?i.routeDisplay[0]:typeof i.routeDisplay=="string"?n(i.routeDisplay)[0]:null:r.opts.routeFinder.routeDisplay!==null&&(u=r.opts.routeFinder.routeDisplay instanceof jQuery?r.opts.routeFinder.routeDisplay[0]:typeof r.opts.routeFinder.routeDisplay=="string"?n(r.opts.routeFinder.routeDisplay)[0]:null),f.setMap(l),u!==null&&f.setPanel(u),s=e[r.opts.routeFinder.travelMode]!==undefined?e[r.opts.routeFinder.travelMode]:e.BYCAR,h=o[r.opts.routeFinder.travelUnit]!==undefined?o[r.opts.routeFinder.travelUnit]:o.KM,c={origin:i.from,destination:i.to,travelMode:s,unitSystem:h},a.route(c,function(i,e){e==t.DirectionsStatus.OK?f.setDirections(i):u!==null&&n(u).html(r.opts.routeFinder.routeErrors[e])}),this}},n.fn.gMap=function(t){if(i[t])return i[t].apply(this,Array.prototype.slice.call(arguments,1));if(typeof t!="object"&&t)n.error("Method "+t+" does not exist on jQuery.gmap");else return i.init.apply(this,arguments)},n.fn.gMap.defaults={log:!1,address:"",latitude:null,longitude:null,zoom:3,maxZoom:null,minZoom:null,markers:[],controls:{},scrollwheel:!0,maptype:google.maps.MapTypeId.ROADMAP,mapTypeControl:!0,zoomControl:!0,panControl:!1,scaleControl:!1,streetViewControl:!0,controlsPositions:{mapType:null,zoom:null,pan:null,scale:null,streetView:null},controlsStyle:{mapType:google.maps.MapTypeControlStyle.DEFAULT,zoom:google.maps.ZoomControlStyle.DEFAULT},singleInfoWindow:!0,html_prepend:'<div class="gmap_marker">',html_append:"<\/div>",icon:{image:"http://www.google.com/mapfiles/marker.png",iconsize:[20,34],iconanchor:[9,34],infowindowanchor:[9,2],shadow:"http://www.google.com/mapfiles/shadow50.png",shadowsize:[37,34],shadowanchor:[9,34]},onComplete:function(){},routeFinder:{travelMode:"BYCAR",travelUnit:"KM",routeDisplay:null,routeErrors:{INVALID_REQUEST:"The provided request is invalid.",NOT_FOUND:"One or more of the given addresses could not be found.",OVER_QUERY_LIMIT:"A temporary error occured. Please try again in a few minutes.",REQUEST_DENIED:"An error occured. Please contact us.",UNKNOWN_ERROR:"An unknown error occured. Please try again.",ZERO_RESULTS:"No route could be found within the given addresses."}},clustering:{enabled:!1,fastClustering:!1,clusterCount:10,clusterSize:40},extra:{}}})(jQuery);